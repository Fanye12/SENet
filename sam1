from utils import generate_augment_imgs,call_gpt4o_with_image, run_sam_segmentation, build_prompt, extract_bbox, process_coords, remove_duplicate_bboxes, draw_bboxes_on_image, build_select_prompt, extract_best_box_number, draw_bbox_on_image, build_optimize_prompt, extract_optimized_box, get_center_point

def agent_seg(img_path, task):

    #生成多张增广图像
    img_path_list = generate_augment_imgs(img_path)
    print(img_path_list)
    #让LLM输出bbox
    prompt = build_prompt(task)
    print(prompt)
    coords_list = []
    #四张图象生成四个坐标
    for img in img_path_list:
        print(img)
        response = call_gpt4o_with_image(img, prompt)
        print(response)
        coords_list.append(extract_bbox(response))
    print(coords_list)
    
    #根据空间关系将坐标映射到原始图像
    coords_list = process_coords(coords_list)
    print(coords_list)

    #去重，去除IoU较高的框
    filtered_coords_list = remove_duplicate_bboxes(coords_list)
    print(filtered_coords_list)

    #SoM，将框加到原图上
    bbox_img_path = draw_bboxes_on_image(img_path, filtered_coords_list)
    print(bbox_img_path)

    #根据加了很多框的图像让LLM选择最合适的框，
    select_prompt = build_select_prompt(task, filtered_coords_list)
    print(select_prompt)

    response = call_gpt4o_with_image(bbox_img_path, select_prompt)
    print(response)
    best_box_index = extract_best_box_number(response)
    print(best_box_index)

    #选出最合适的框，再将其加到原图上
    best_box_coord = filtered_coords_list[int(best_box_index) - 1]
    best_box_img_path = draw_bbox_on_image(img_path, best_box_coord, 'with_selected_box')

    #让LLM继续改进框
    prompt = build_optimize_prompt(task, best_box_coord)
    print(prompt)

    response = call_gpt4o_with_image(best_box_img_path, prompt)
    print(response)

    #得到优化后的坐标
    refined_coord = extract_optimized_box(response)
    if not refined_coord:
        refined_coord = best_box_coord

    #保存优化后的框叠加到原图
    best_box_img_path = draw_bbox_on_image(img_path, refined_coord, 'with_refined_box')

    #使用SAM进行分割
    run_sam_segmentation(image_path=img_path,
    point_coords=get_center_point(refined_coord),
    point_labels=[1],
    bbox=refined_coord)









if __name__ == '__main__':
    img_path = '/home/kevin/androidworld2/SAM/images/dog4.jpg'
    # prompt_for_cat = build_prompt("cat")
    # text_prompt = build_prompt("dog")
    # prompt_for_camouflage = build_prompt("camouflaged object that blends into the background")
    task = 'dog'
    agent_seg(img_path, task)
